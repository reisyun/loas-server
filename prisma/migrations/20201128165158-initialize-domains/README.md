# Migration `20201128165158-initialize-domains`

This migration has been generated by reisyun at 11/29/2020, 1:52:06 AM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
CREATE TYPE "public"."UserRole" AS ENUM ('USER', 'ADMIN')

CREATE TYPE "public"."Gender" AS ENUM ('SECRET', 'MALE', 'FEMALE')

CREATE TYPE "public"."Language" AS ENUM ('KOREAN', 'ENGLISH', 'JAPANESE')

CREATE TYPE "public"."CollectionCategory" AS ENUM ('CURRENT', 'PLANNING', 'COMPLETED', 'CUSTOM')

CREATE TYPE "public"."MediaFormat" AS ENUM ('TVA', 'OVA', 'ONA', 'MOVIE', 'MUSIC', 'SPECIAL')

CREATE TYPE "public"."MediaStatus" AS ENUM ('RELEASING', 'FINISHED', 'UNRELEASED', 'CANCELLED')

CREATE TABLE "user" (
    "id" TEXT NOT NULL,
    "name" TEXT NOT NULL,
    "email" TEXT NOT NULL,
    "password" TEXT NOT NULL,
    "verified" BOOLEAN NOT NULL DEFAULT false,
    "role" "UserRole" NOT NULL DEFAULT E'USER',
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,

    PRIMARY KEY ("id")
)

CREATE TABLE "user_deleted" (
    "id" TEXT NOT NULL,
    "email" TEXT,
    "disabled" BOOLEAN NOT NULL,
    "deletedAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,

    PRIMARY KEY ("id")
)

CREATE TABLE "profile" (
"id" SERIAL,
    "shortBio" TEXT,
    "avatar" TEXT,
    "gender" "Gender" NOT NULL DEFAULT E'SECRET',
    "language" "Language" NOT NULL DEFAULT E'ENGLISH',
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "removedAt" TIMESTAMP(3),
    "userId" TEXT,

    PRIMARY KEY ("id")
)

CREATE TABLE "review" (
    "id" TEXT NOT NULL,
    "body" TEXT NOT NULL,
    "spoiler" BOOLEAN NOT NULL DEFAULT true,
    "private" BOOLEAN NOT NULL DEFAULT false,
    "likeCount" INTEGER NOT NULL DEFAULT 0,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "userId" TEXT NOT NULL,
    "mediaId" INTEGER NOT NULL,

    PRIMARY KEY ("id")
)

CREATE TABLE "collection" (
    "id" TEXT NOT NULL,
    "name" TEXT NOT NULL,
    "description" TEXT,
    "category" "CollectionCategory" NOT NULL DEFAULT E'CUSTOM',
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "removedAt" TIMESTAMP(3),
    "collectorId" TEXT,

    PRIMARY KEY ("id")
)

CREATE TABLE "collection_item" (
"id" SERIAL,
    "like" BOOLEAN,
    "private" BOOLEAN NOT NULL DEFAULT false,
    "repeat" INTEGER NOT NULL DEFAULT 0,
    "completedAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "collectionId" TEXT NOT NULL,
    "mediaId" INTEGER NOT NULL,

    PRIMARY KEY ("id")
)

CREATE TABLE "media" (
"id" SERIAL,
    "title" TEXT NOT NULL,
    "image" TEXT,
    "likeCount" INTEGER NOT NULL DEFAULT 0,
    "dislikeCount" INTEGER NOT NULL DEFAULT 0,
    "synopsis" TEXT,
    "studio" TEXT,
    "format" "MediaFormat",
    "status" "MediaStatus",
    "startDate" TIMESTAMP(3),
    "endDate" TIMESTAMP(3),
    "episodeCount" INTEGER,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "removedAt" TIMESTAMP(3),

    PRIMARY KEY ("id")
)

CREATE TABLE "genre" (
"id" SERIAL,
    "name" TEXT NOT NULL,

    PRIMARY KEY ("id")
)

CREATE TABLE "_GenreToMedia" (
    "A" INTEGER NOT NULL,
    "B" INTEGER NOT NULL
)

CREATE UNIQUE INDEX "user.email_unique" ON "user"("email")

CREATE UNIQUE INDEX "profile_userId_unique" ON "profile"("userId")

CREATE UNIQUE INDEX "review.mediaId_unique" ON "review"("mediaId")

CREATE UNIQUE INDEX "collection_item.mediaId_unique" ON "collection_item"("mediaId")

CREATE INDEX "media.title_studio_index" ON "media"("title", "studio")

CREATE UNIQUE INDEX "_GenreToMedia_AB_unique" ON "_GenreToMedia"("A", "B")

CREATE INDEX "_GenreToMedia_B_index" ON "_GenreToMedia"("B")

ALTER TABLE "profile" ADD FOREIGN KEY("userId")REFERENCES "user"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "profile" ADD FOREIGN KEY("userId")REFERENCES "user_deleted"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "review" ADD FOREIGN KEY("userId")REFERENCES "user"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "review" ADD FOREIGN KEY("mediaId")REFERENCES "media"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "collection" ADD FOREIGN KEY("collectorId")REFERENCES "user"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "collection" ADD FOREIGN KEY("collectorId")REFERENCES "user_deleted"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "collection_item" ADD FOREIGN KEY("collectionId")REFERENCES "collection"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "collection_item" ADD FOREIGN KEY("mediaId")REFERENCES "media"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "_GenreToMedia" ADD FOREIGN KEY("A")REFERENCES "genre"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "_GenreToMedia" ADD FOREIGN KEY("B")REFERENCES "media"("id") ON DELETE CASCADE ON UPDATE CASCADE
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration ..20201128165158-initialize-domains
--- datamodel.dml
+++ datamodel.dml
@@ -1,0 +1,180 @@
+datasource db {
+  provider = "postgresql"
+  url = "***"
+}
+
+generator client {
+  provider = "prisma-client-js"
+}
+
+enum UserRole {
+  USER
+  ADMIN
+}
+
+model User {
+  id        String   @id @default(uuid())
+  name      String
+  email     String   @unique
+  password  String
+  verified  Boolean  @default(false)
+  role      UserRole @default(USER)
+  createdAt DateTime @default(now())
+  updatedAt DateTime @default(now()) @updatedAt
+
+  profile     Profile?
+  reviews     Review[]
+  collections Collection[]
+
+  @@map(name: "user")
+}
+
+// 비활성화 여부를 확인해 복구 요청을 판단
+model DeletedUser {
+  id        String   @id
+  email     String?
+  disabled  Boolean
+  deletedAt DateTime @default(now())
+
+  profile     Profile?
+  collections Collection[]
+
+  @@map(name: "user_deleted")
+}
+
+enum Gender {
+  SECRET
+  MALE
+  FEMALE
+}
+
+enum Language {
+  KOREAN
+  ENGLISH
+  JAPANESE
+}
+
+model Profile {
+  id        Int       @id @default(autoincrement())
+  shortBio  String?
+  avatar    String?
+  gender    Gender    @default(SECRET)
+  language  Language  @default(ENGLISH)
+  createdAt DateTime  @default(now())
+  updatedAt DateTime  @default(now()) @updatedAt
+  removedAt DateTime?
+
+  user        User?        @relation(fields: [userId], references: [id])
+  userId      String?
+  deletedUser DeletedUser? @relation(fields: [userId], references: [id])
+
+  @@map(name: "profile")
+}
+
+model Review {
+  id        String   @id @default(uuid())
+  body      String
+  spoiler   Boolean  @default(true)
+  private   Boolean  @default(false)
+  likeCount Int      @default(0)
+  createdAt DateTime @default(now())
+  updatedAt DateTime @default(now()) @updatedAt
+
+  user    User   @relation(fields: [userId], references: [id])
+  userId  String
+  media   Media  @relation(fields: [mediaId], references: [id])
+  mediaId Int    @unique
+
+  @@map(name: "review")
+}
+
+enum CollectionCategory {
+  CURRENT
+  PLANNING
+  COMPLETED
+  CUSTOM
+}
+
+model Collection {
+  id          String             @id @default(uuid())
+  name        String
+  description String?
+  category    CollectionCategory @default(CUSTOM)
+  createdAt   DateTime           @default(now())
+  updatedAt   DateTime           @default(now()) @updatedAt
+  removedAt   DateTime?
+
+  collector        User?            @relation(fields: [collectorId], references: [id])
+  collectorId      String?
+  deletedCollector DeletedUser?     @relation(fields: [collectorId], references: [id])
+  collectionItems  CollectionItem[]
+
+  @@map(name: "collection")
+}
+
+model CollectionItem {
+  id          Int      @id @default(autoincrement())
+  like        Boolean?
+  private     Boolean  @default(false)
+  repeat      Int      @default(0)
+  completedAt DateTime @default(now())
+  createdAt   DateTime @default(now())
+  updatedAt   DateTime @default(now()) @updatedAt
+
+  collection   Collection @relation(fields: [collectionId], references: [id])
+  collectionId String
+  media        Media      @relation(fields: [mediaId], references: [id])
+  mediaId      Int        @unique
+
+  @@map(name: "collection_item")
+}
+
+enum MediaFormat {
+  TVA
+  OVA
+  ONA
+  MOVIE
+  MUSIC
+  SPECIAL
+}
+
+enum MediaStatus {
+  RELEASING
+  FINISHED
+  UNRELEASED
+  CANCELLED
+}
+
+model Media {
+  id           Int          @id @default(autoincrement())
+  title        String
+  image        String?
+  likeCount    Int          @default(0)
+  dislikeCount Int          @default(0)
+  synopsis     String?
+  studio       String?
+  format       MediaFormat?
+  status       MediaStatus?
+  startDate    DateTime?
+  endDate      DateTime?
+  episodeCount Int?
+  createdAt    DateTime     @default(now())
+  updatedAt    DateTime     @default(now()) @updatedAt
+  removedAt    DateTime?
+
+  genres          Genre[]          @relation(references: [id])
+  reviews         Review[]
+  collectionItems CollectionItem[]
+
+  @@index([title, studio])
+  @@map(name: "media")
+}
+
+model Genre {
+  id   Int    @id @default(autoincrement())
+  name String
+
+  media Media[] @relation(references: [id])
+
+  @@map(name: "genre")
+}
```


