# Migration `20201005012017-initialize`

This migration has been generated by reisyun at 10/5/2020, 10:20:28 AM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
CREATE TYPE "public"."UserRole" AS ENUM ('USER', 'ADMIN')

CREATE TYPE "public"."Gender" AS ENUM ('SECRET', 'MALE', 'FEMALE')

CREATE TYPE "public"."Language" AS ENUM ('KOREAN', 'ENGLISH', 'JAPANESE')

CREATE TYPE "public"."RecordStatus" AS ENUM ('CURRENT', 'PLANNING', 'COMPLETED')

CREATE TYPE "public"."Format" AS ENUM ('TVA', 'OVA', 'ONA', 'MOVIE', 'MUSIC', 'SPECIAL')

CREATE TYPE "public"."MediaStatus" AS ENUM ('RELEASING', 'FINISHED', 'UNRELEASED', 'CANCELLED')

CREATE TABLE "public"."user" (
"id" text   NOT NULL ,
"name" text   NOT NULL ,
"email" text   NOT NULL ,
"password" text   NOT NULL ,
"verified" boolean   NOT NULL DEFAULT false,
"role" "UserRole"  NOT NULL DEFAULT E'USER',
"createdAt" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
"updatedAt" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
"removedAt" timestamp(3)   ,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."profile" (
"id" SERIAL,
"shortBio" text   ,
"avatar" text   ,
"gender" "Gender"  NOT NULL DEFAULT E'SECRET',
"language" "Language"  NOT NULL DEFAULT E'ENGLISH',
"userId" text   NOT NULL ,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."library" (
"id" text   NOT NULL ,
"name" text   NOT NULL ,
"description" text   ,
"private" boolean   NOT NULL DEFAULT false,
"isCustom" boolean   NOT NULL DEFAULT true,
"createdAt" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
"updatedAt" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
"removedAt" timestamp(3)   ,
"userId" text   NOT NULL ,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."record" (
"status" "RecordStatus"  NOT NULL DEFAULT E'PLANNING',
"like" boolean   ,
"completedAt" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
"createdAt" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
"updatedAt" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
"libraryId" text   NOT NULL ,
"mediaId" integer   NOT NULL ,
PRIMARY KEY ("mediaId")
)

CREATE TABLE "public"."review" (
"id" text   NOT NULL ,
"content" text   NOT NULL ,
"spoiler" boolean   NOT NULL DEFAULT true,
"private" boolean   NOT NULL ,
"likeCount" integer   NOT NULL DEFAULT 0,
"createdAt" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
"updatedAt" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
"userId" text   NOT NULL ,
"mediaId" integer   NOT NULL ,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."media" (
"id" SERIAL,
"title" text   NOT NULL ,
"image" text   ,
"likeCount" integer   NOT NULL DEFAULT 0,
"dislikeCount" integer   NOT NULL DEFAULT 0,
"synopsis" text   ,
"studio" text   ,
"format" "Format"  ,
"startDate" timestamp(3)   ,
"endDate" timestamp(3)   ,
"episodeCount" integer   ,
"status" "MediaStatus"  ,
"createdAt" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
"updatedAt" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."genre" (
"id" SERIAL,
"name" text   NOT NULL ,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."_GenreToMedia" (
"A" integer   NOT NULL ,
"B" integer   NOT NULL 
)

CREATE UNIQUE INDEX "user.email_unique" ON "public"."user"("email")

CREATE UNIQUE INDEX "profile.userId_unique" ON "public"."profile"("userId")

CREATE INDEX "media.title_studio_index" ON "public"."media"("title", "studio")

CREATE UNIQUE INDEX "_GenreToMedia_AB_unique" ON "public"."_GenreToMedia"("A", "B")

CREATE INDEX "_GenreToMedia_B_index" ON "public"."_GenreToMedia"("B")

ALTER TABLE "public"."profile" ADD FOREIGN KEY ("userId")REFERENCES "public"."user"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."library" ADD FOREIGN KEY ("userId")REFERENCES "public"."user"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."record" ADD FOREIGN KEY ("libraryId")REFERENCES "public"."library"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."record" ADD FOREIGN KEY ("mediaId")REFERENCES "public"."media"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."review" ADD FOREIGN KEY ("userId")REFERENCES "public"."user"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."review" ADD FOREIGN KEY ("mediaId")REFERENCES "public"."media"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."_GenreToMedia" ADD FOREIGN KEY ("A")REFERENCES "public"."genre"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."_GenreToMedia" ADD FOREIGN KEY ("B")REFERENCES "public"."media"("id") ON DELETE CASCADE ON UPDATE CASCADE
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration ..20201005012017-initialize
--- datamodel.dml
+++ datamodel.dml
@@ -1,0 +1,161 @@
+datasource db {
+  provider = "postgresql"
+  url = "***"
+}
+
+generator client {
+  provider = "prisma-client-js"
+}
+
+enum UserRole {
+  USER
+  ADMIN
+}
+
+model User {
+  id        String    @id @default(uuid())
+  name      String
+  email     String    @unique
+  password  String
+  verified  Boolean   @default(false)
+  role      UserRole  @default(USER)
+  createdAt DateTime  @default(now())
+  updatedAt DateTime  @default(now()) @updatedAt
+  removedAt DateTime?
+
+  profile   Profile?
+  libraries Library[]
+  reviews   Review[]
+
+  @@map(name: "user")
+}
+
+enum Gender {
+  SECRET
+  MALE
+  FEMALE
+}
+
+enum Language {
+  KOREAN
+  ENGLISH
+  JAPANESE
+}
+
+model Profile {
+  id       Int      @id @default(autoincrement())
+  shortBio String?
+  avatar   String?
+  gender   Gender   @default(SECRET)
+  language Language @default(ENGLISH)
+
+  user   User   @relation(fields: [userId], references: [id])
+  userId String @unique
+
+  @@map(name: "profile")
+}
+
+model Library {
+  id          String    @id @default(uuid())
+  name        String
+  description String?
+  private     Boolean   @default(false)
+  isCustom    Boolean   @default(true)
+  createdAt   DateTime  @default(now())
+  updatedAt   DateTime  @default(now()) @updatedAt
+  removedAt   DateTime?
+
+  user    User     @relation(fields: [userId], references: [id])
+  userId  String
+  records Record[]
+
+  @@map(name: "library")
+}
+
+enum RecordStatus {
+  CURRENT
+  PLANNING
+  COMPLETED
+}
+
+model Record {
+  status      RecordStatus @default(PLANNING)
+  like        Boolean?
+  completedAt DateTime     @default(now())
+  createdAt   DateTime     @default(now())
+  updatedAt   DateTime     @default(now()) @updatedAt
+
+  library   Library @relation(fields: [libraryId], references: [id])
+  libraryId String
+  media     Media   @relation(fields: [mediaId], references: [id])
+  mediaId   Int     @id
+
+  @@map(name: "record")
+}
+
+// Record 추가 없이 Review 쓰기 가능
+model Review {
+  id        String   @id @default(uuid())
+  content   String
+  spoiler   Boolean  @default(true)
+  private   Boolean
+  likeCount Int      @default(0)
+  createdAt DateTime @default(now())
+  updatedAt DateTime @default(now()) @updatedAt
+
+  user    User   @relation(fields: [userId], references: [id])
+  userId  String
+  media   Media  @relation(fields: [mediaId], references: [id])
+  mediaId Int
+
+  @@map(name: "review")
+}
+
+enum Format {
+  TVA
+  OVA
+  ONA
+  MOVIE
+  MUSIC
+  SPECIAL
+}
+
+enum MediaStatus {
+  RELEASING
+  FINISHED
+  UNRELEASED
+  CANCELLED
+}
+
+model Media {
+  id           Int          @id @default(autoincrement())
+  title        String
+  image        String?
+  likeCount    Int          @default(0)
+  dislikeCount Int          @default(0)
+  synopsis     String?
+  studio       String?
+  format       Format?
+  startDate    DateTime?
+  endDate      DateTime?
+  episodeCount Int?
+  status       MediaStatus?
+  createdAt    DateTime     @default(now())
+  updatedAt    DateTime     @default(now()) @updatedAt
+
+  genres  Genre[]  @relation(references: [id])
+  records Record[]
+  reviews Review[]
+
+  @@index([title, studio])
+  @@map(name: "media")
+}
+
+model Genre {
+  id   Int    @id @default(autoincrement())
+  name String
+
+  media Media[] @relation(references: [id])
+
+  @@map(name: "genre")
+}
```


