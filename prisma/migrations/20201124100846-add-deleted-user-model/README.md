# Migration `20201124100846-add-deleted-user-model`

This migration has been generated by reisyun at 11/24/2020, 7:08:50 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
ALTER TABLE "media_collection" ALTER COLUMN "userId" DROP NOT NULL

ALTER TABLE "profile" ALTER COLUMN "userId" DROP NOT NULL

ALTER TABLE "user" DROP COLUMN "removedAt"

CREATE TABLE "user_deleted" (
    "id" TEXT NOT NULL,
    "email" TEXT NOT NULL,
    "removedAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,

    PRIMARY KEY ("id")
)

ALTER TABLE "media_collection" ADD FOREIGN KEY("userId")REFERENCES "user_deleted"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "profile" ADD FOREIGN KEY("userId")REFERENCES "user_deleted"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER INDEX "profile.userId_unique" RENAME TO "profile_userId_unique"
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20201123102434-initialize..20201124100846-add-deleted-user-model
--- datamodel.dml
+++ datamodel.dml
@@ -1,7 +1,7 @@
 datasource db {
   provider = "postgresql"
-  url = "***"
+  url = "***"
 }
 generator client {
   provider = "prisma-client-js"
@@ -12,25 +12,35 @@
   ADMIN
 }
 model User {
-  id        String    @id @default(uuid())
+  id        String   @id @default(uuid())
   name      String
-  email     String    @unique
+  email     String   @unique
   password  String
-  verified  Boolean   @default(false)
-  role      UserRole  @default(USER)
-  createdAt DateTime  @default(now())
-  updatedAt DateTime  @default(now()) @updatedAt
-  removedAt DateTime?
+  verified  Boolean  @default(false)
+  role      UserRole @default(USER)
+  createdAt DateTime @default(now())
+  updatedAt DateTime @default(now()) @updatedAt
   profile     Profile?
   reviews     Review[]
   collections MediaCollection[]
   @@map(name: "user")
 }
+model DeletedUser {
+  id        String   @id
+  email     String
+  removedAt DateTime @default(now())
+
+  profile     Profile?
+  collections MediaCollection[]
+
+  @@map(name: "user_deleted")
+}
+
 enum Gender {
   SECRET
   MALE
   FEMALE
@@ -48,10 +58,11 @@
   avatar   String?
   gender   Gender   @default(SECRET)
   language Language @default(ENGLISH)
-  user   User   @relation(fields: [userId], references: [id])
-  userId String @unique
+  user        User?        @relation(fields: [userId], references: [id])
+  userId      String?
+  deletedUser DeletedUser? @relation(fields: [userId], references: [id])
   @@map(name: "profile")
 }
@@ -80,11 +91,12 @@
   createdAt   DateTime  @default(now())
   updatedAt   DateTime  @default(now()) @updatedAt
   removedAt   DateTime?
-  user      User        @relation(fields: [userId], references: [id])
-  userId    String
-  mediaList MediaItem[]
+  user        User?        @relation(fields: [userId], references: [id])
+  userId      String?
+  deletedUser DeletedUser? @relation(fields: [userId], references: [id])
+  mediaList   MediaItem[]
   @@map(name: "media_collection")
 }
```


