# Migration `20201226104059-add-history`

This migration has been generated by reisyun at 12/26/2020, 7:41:14 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
CREATE TYPE "public"."UserRole" AS ENUM ('USER', 'ADMIN')

CREATE TYPE "public"."Gender" AS ENUM ('SECRET', 'MALE', 'FEMALE')

CREATE TYPE "public"."Language" AS ENUM ('KOREAN', 'ENGLISH', 'JAPANESE')

CREATE TYPE "public"."HistoryCategory" AS ENUM ('PLANNING', 'CURRENT', 'COMPLETED')

CREATE TYPE "public"."MediaFormat" AS ENUM ('TVA', 'OVA', 'ONA', 'MOVIE', 'MUSIC', 'SPECIAL')

CREATE TYPE "public"."MediaStatus" AS ENUM ('RELEASING', 'FINISHED', 'UNRELEASED', 'CANCELLED')

CREATE TABLE "user" (
    "id" TEXT NOT NULL,
    "name" TEXT NOT NULL,
    "email" TEXT NOT NULL,
    "password" TEXT NOT NULL,
    "verified" BOOLEAN NOT NULL DEFAULT false,
    "role" "UserRole" NOT NULL DEFAULT E'USER',
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    "removedAt" TIMESTAMP(3),
    "profileId" INTEGER NOT NULL,

    PRIMARY KEY ("id")
)

CREATE TABLE "profile" (
"id" SERIAL,
    "shortBio" TEXT,
    "avatar" TEXT,
    "gender" "Gender" NOT NULL DEFAULT E'SECRET',
    "language" "Language" NOT NULL DEFAULT E'ENGLISH',

    PRIMARY KEY ("id")
)

CREATE TABLE "review" (
    "id" TEXT NOT NULL,
    "body" TEXT NOT NULL,
    "spoiler" BOOLEAN NOT NULL DEFAULT true,
    "private" BOOLEAN NOT NULL DEFAULT false,
    "likeCount" INTEGER NOT NULL DEFAULT 0,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    "userId" TEXT NOT NULL,
    "mediaId" INTEGER NOT NULL,

    PRIMARY KEY ("id")
)

CREATE TABLE "history" (
    "id" TEXT NOT NULL,
    "category" "HistoryCategory" NOT NULL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    "removedAt" TIMESTAMP(3),
    "collectorId" TEXT NOT NULL,

    PRIMARY KEY ("id")
)

CREATE TABLE "history_item" (
    "id" TEXT NOT NULL,
    "repeat" INTEGER NOT NULL DEFAULT 0,
    "private" BOOLEAN NOT NULL DEFAULT false,
    "completedAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    "historyId" TEXT NOT NULL,
    "mediaId" INTEGER NOT NULL,

    PRIMARY KEY ("id")
)

CREATE TABLE "collection" (
    "id" TEXT NOT NULL,
    "name" TEXT NOT NULL,
    "description" TEXT,
    "private" BOOLEAN NOT NULL DEFAULT false,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    "removedAt" TIMESTAMP(3),
    "collectorId" TEXT NOT NULL,

    PRIMARY KEY ("id")
)

CREATE TABLE "collection_like_dislike" (
"id" SERIAL,
    "isLike" BOOLEAN NOT NULL,
    "collectorId" TEXT NOT NULL,
    "collectionId" TEXT NOT NULL,

    PRIMARY KEY ("id")
)

CREATE TABLE "collection_item" (
    "id" TEXT NOT NULL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    "collectionId" TEXT NOT NULL,
    "mediaId" INTEGER NOT NULL,

    PRIMARY KEY ("id")
)

CREATE TABLE "media" (
"id" SERIAL,
    "title" TEXT NOT NULL,
    "image" TEXT,
    "synopsis" TEXT,
    "studio" TEXT,
    "format" "MediaFormat",
    "status" "MediaStatus",
    "startDate" TIMESTAMP(3),
    "endDate" TIMESTAMP(3),
    "episodeCount" INTEGER,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    "removedAt" TIMESTAMP(3),

    PRIMARY KEY ("id")
)

CREATE TABLE "media_like_dislike" (
"id" SERIAL,
    "isLike" BOOLEAN NOT NULL,
    "userId" TEXT NOT NULL,
    "mediaId" INTEGER NOT NULL,

    PRIMARY KEY ("id")
)

CREATE TABLE "genre" (
"id" SERIAL,
    "name" TEXT NOT NULL,

    PRIMARY KEY ("id")
)

CREATE TABLE "_GenreToMedia" (
    "A" INTEGER NOT NULL,
    "B" INTEGER NOT NULL
)

CREATE UNIQUE INDEX "user.email_unique" ON "user"("email")

CREATE UNIQUE INDEX "user_profileId_unique" ON "user"("profileId")

CREATE UNIQUE INDEX "review.mediaId_unique" ON "review"("mediaId")

CREATE INDEX "media.title_studio_index" ON "media"("title", "studio")

CREATE UNIQUE INDEX "_GenreToMedia_AB_unique" ON "_GenreToMedia"("A", "B")

CREATE INDEX "_GenreToMedia_B_index" ON "_GenreToMedia"("B")

ALTER TABLE "user" ADD FOREIGN KEY("profileId")REFERENCES "profile"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "review" ADD FOREIGN KEY("userId")REFERENCES "user"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "review" ADD FOREIGN KEY("mediaId")REFERENCES "media"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "history" ADD FOREIGN KEY("collectorId")REFERENCES "user"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "history_item" ADD FOREIGN KEY("historyId")REFERENCES "history"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "history_item" ADD FOREIGN KEY("mediaId")REFERENCES "media"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "collection" ADD FOREIGN KEY("collectorId")REFERENCES "user"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "collection_like_dislike" ADD FOREIGN KEY("collectorId")REFERENCES "user"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "collection_like_dislike" ADD FOREIGN KEY("collectionId")REFERENCES "collection"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "collection_item" ADD FOREIGN KEY("collectionId")REFERENCES "collection"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "collection_item" ADD FOREIGN KEY("mediaId")REFERENCES "media"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "media_like_dislike" ADD FOREIGN KEY("userId")REFERENCES "user"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "media_like_dislike" ADD FOREIGN KEY("mediaId")REFERENCES "media"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "_GenreToMedia" ADD FOREIGN KEY("A")REFERENCES "genre"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "_GenreToMedia" ADD FOREIGN KEY("B")REFERENCES "media"("id") ON DELETE CASCADE ON UPDATE CASCADE
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20201217124543-fix-type-uuid-to-collection-item-id..20201226104059-add-history
--- datamodel.dml
+++ datamodel.dml
@@ -1,51 +1,42 @@
 datasource db {
   provider = "postgresql"
-  url = "***"
+  url = "***"
 }
 generator client {
   provider = "prisma-client-js"
 }
+// User
+
 enum UserRole {
   USER
   ADMIN
 }
 model User {
-  id        String   @id @default(uuid())
+  id        String    @id @default(uuid())
   name      String
-  email     String   @unique
+  email     String    @unique
   password  String
-  verified  Boolean  @default(false)
-  role      UserRole @default(USER)
-  createdAt DateTime @default(now())
-  updatedAt DateTime @updatedAt
+  verified  Boolean   @default(false)
+  role      UserRole  @default(USER)
+  createdAt DateTime  @default(now())
+  updatedAt DateTime  @updatedAt
+  removedAt DateTime?
+  profile                Profile                 @relation(fields: [profileId], references: [id])
+  profileId              Int
+  histories              History[]
+  collections            Collection[]
+  collectionLikeDisLikes CollectionLikeDisLike[]
+  mediaLikeDisLikes      MediaLikeDisLike[]
+  reviews                Review[]
-  profile     Profile      @relation(fields: [profileId], references: [id])
-  profileId   Int
-  reviews     Review[]
-  collections Collection[]
-
   @@map(name: "user")
 }
-// 비활성화 여부를 확인해 복구 요청을 판단
-model DeletedUser {
-  id        String   @id
-  email     String?
-  disabled  Boolean
-  deletedAt DateTime @default(now())
-
-  profile     Profile      @relation(fields: [profileId], references: [id])
-  profileId   Int
-  collections Collection[]
-
-  @@map(name: "user_deleted")
-}
-
 enum Gender {
   SECRET
   MALE
   FEMALE
@@ -63,14 +54,15 @@
   avatar   String?
   gender   Gender   @default(SECRET)
   language Language @default(ENGLISH)
-  user        User?
-  DeletedUser DeletedUser?
+  user User?
   @@map(name: "profile")
 }
+// Review
+
 model Review {
   id        String   @id @default(uuid())
   body      String
   spoiler   Boolean  @default(true)
@@ -86,41 +78,81 @@
   @@map(name: "review")
 }
-enum CollectionCategory {
+// History
+
+enum HistoryCategory {
+  PLANNING
   CURRENT
-  PLANNING
   COMPLETED
-  CUSTOM
 }
+model History {
+  id        String          @id @default(uuid())
+  category  HistoryCategory
+  createdAt DateTime        @default(now())
+  updatedAt DateTime        @updatedAt
+  removedAt DateTime?
+
+  collector    User          @relation(fields: [collectorId], references: [id])
+  collectorId  String
+  historyItems HistoryItem[]
+
+  @@map(name: "history")
+}
+
+model HistoryItem {
+  id          String   @id @default(uuid())
+  repeat      Int      @default(0)
+  private     Boolean  @default(false)
+  completedAt DateTime @default(now())
+  createdAt   DateTime @default(now())
+  updatedAt   DateTime @updatedAt
+
+  history   History @relation(fields: [historyId], references: [id])
+  historyId String
+  media     Media   @relation(fields: [mediaId], references: [id])
+  mediaId   Int
+
+  @@map(name: "history_item")
+}
+
+// Collection
+
 model Collection {
-  id          String             @id @default(uuid())
+  id          String    @id @default(uuid())
   name        String
   description String?
-  category    CollectionCategory @default(CUSTOM)
-  createdAt   DateTime           @default(now())
-  updatedAt   DateTime           @updatedAt
+  private     Boolean   @default(false)
+  createdAt   DateTime  @default(now())
+  updatedAt   DateTime  @updatedAt
   removedAt   DateTime?
-  collector          User?            @relation(fields: [collectorId], references: [id])
-  collectorId        String?
-  deletedCollector   DeletedUser?     @relation(fields: [deletedCollectorId], references: [id])
-  deletedCollectorId String?
-  collectionItems    CollectionItem[]
+  collector              User                    @relation(fields: [collectorId], references: [id])
+  collectorId            String
+  collectionLikeDisLikes CollectionLikeDisLike[]
+  collectionItems        CollectionItem[]
   @@map(name: "collection")
 }
+model CollectionLikeDisLike {
+  id     Int     @id @default(autoincrement())
+  isLike Boolean
+
+  collector    User       @relation(fields: [collectorId], references: [id])
+  collectorId  String
+  collection   Collection @relation(fields: [collectionId], references: [id])
+  collectionId String
+
+  @@map(name: "collection_like_dislike")
+}
+
 model CollectionItem {
-  id          String   @id @default(uuid())
-  like        Boolean?
-  private     Boolean  @default(false)
-  repeat      Int      @default(0)
-  completedAt DateTime @default(now())
-  createdAt   DateTime @default(now())
-  updatedAt   DateTime @updatedAt
+  id        String   @id @default(uuid())
+  createdAt DateTime @default(now())
+  updatedAt DateTime @updatedAt
   collection   Collection @relation(fields: [collectionId], references: [id])
   collectionId String
   media        Media      @relation(fields: [mediaId], references: [id])
@@ -128,8 +160,10 @@
   @@map(name: "collection_item")
 }
+// Media
+
 enum MediaFormat {
   TVA
   OVA
   ONA
@@ -148,10 +182,8 @@
 model Media {
   id           Int          @id @default(autoincrement())
   title        String
   image        String?
-  likeCount    Int          @default(0)
-  dislikeCount Int          @default(0)
   synopsis     String?
   studio       String?
   format       MediaFormat?
   status       MediaStatus?
@@ -161,16 +193,30 @@
   createdAt    DateTime     @default(now())
   updatedAt    DateTime     @updatedAt
   removedAt    DateTime?
-  genres          Genre[]          @relation(references: [id])
-  reviews         Review[]
-  collectionItems CollectionItem[]
+  mediaLikeDisLikes MediaLikeDisLike[]
+  genres            Genre[]            @relation(references: [id])
+  reviews           Review[]
+  historyItems      HistoryItem[]
+  collectionItems   CollectionItem[]
   @@index([title, studio])
   @@map(name: "media")
 }
+model MediaLikeDisLike {
+  id     Int     @id @default(autoincrement())
+  isLike Boolean
+
+  user    User   @relation(fields: [userId], references: [id])
+  userId  String
+  media   Media  @relation(fields: [mediaId], references: [id])
+  mediaId Int
+
+  @@map(name: "media_like_dislike")
+}
+
 model Genre {
   id   Int    @id @default(autoincrement())
   name String
```


