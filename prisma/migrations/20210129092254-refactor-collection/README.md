# Migration `20210129092254-refactor-collection`

This migration has been generated by reisyun at 1/29/2021, 6:23:13 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
CREATE TYPE "public"."Gender" AS ENUM ('SECRET', 'MALE', 'FEMALE')

CREATE TYPE "public"."Language" AS ENUM ('KOREAN', 'ENGLISH', 'JAPANESE')

CREATE TYPE "public"."HistoryCategory" AS ENUM ('PLANNING', 'CURRENT', 'COMPLETED')

CREATE TYPE "public"."MediaStatus" AS ENUM ('FINISHED', 'RELEASING', 'UNRELEASED', 'CANCELLED', 'HIATUS')

CREATE TABLE "user" (
    "id" TEXT NOT NULL,
    "name" TEXT NOT NULL,
    "email" TEXT NOT NULL,
    "password" TEXT NOT NULL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    "removedAt" TIMESTAMP(3),

    PRIMARY KEY ("id")
)

CREATE TABLE "profile" (
    "shortBio" TEXT,
    "avatar" TEXT,
    "gender" "Gender" NOT NULL DEFAULT E'SECRET',
    "language" "Language" NOT NULL DEFAULT E'ENGLISH',
    "userId" TEXT NOT NULL,

    PRIMARY KEY ("userId")
)

CREATE TABLE "history" (
    "id" TEXT NOT NULL,
    "category" "HistoryCategory" NOT NULL,
    "repeat" INTEGER NOT NULL DEFAULT 0,
    "private" BOOLEAN NOT NULL DEFAULT false,
    "completedAt" TIMESTAMP(3) NOT NULL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    "removedAt" TIMESTAMP(3),
    "ownerId" TEXT NOT NULL,
    "mediaId" TEXT NOT NULL,

    PRIMARY KEY ("id")
)

CREATE TABLE "library" (
    "owner" BOOLEAN NOT NULL,
    "addedAt" TIMESTAMP(3) NOT NULL,
    "collectorId" TEXT NOT NULL,
    "collectionId" TEXT NOT NULL,

    PRIMARY KEY ("collectorId","collectionId")
)

CREATE TABLE "collection" (
    "id" TEXT NOT NULL,
    "title" TEXT NOT NULL,
    "description" TEXT,
    "private" BOOLEAN NOT NULL DEFAULT false,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    "removedAt" TIMESTAMP(3),

    PRIMARY KEY ("id")
)

CREATE TABLE "collection_item" (
    "addedAt" TIMESTAMP(3) NOT NULL,
    "collectionId" TEXT NOT NULL,
    "mediaId" TEXT NOT NULL,

    PRIMARY KEY ("collectionId","mediaId")
)

CREATE TABLE "media" (
    "id" TEXT NOT NULL,
"no" SERIAL,
    "status" "MediaStatus" NOT NULL,
    "title" TEXT NOT NULL,
    "synopsis" TEXT,
    "startDate" TIMESTAMP(3),
    "endDate" TIMESTAMP(3),
    "coverImage" TEXT,
    "bannerImage" TEXT,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    "removedAt" TIMESTAMP(3),

    PRIMARY KEY ("id")
)

CREATE TABLE "genre" (
"id" SERIAL,
    "name" TEXT NOT NULL,

    PRIMARY KEY ("id")
)

CREATE TABLE "review" (
    "id" TEXT NOT NULL,
    "content" TEXT NOT NULL,
    "private" BOOLEAN NOT NULL DEFAULT false,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    "userId" TEXT NOT NULL,
    "mediaId" TEXT NOT NULL,

    PRIMARY KEY ("id")
)

CREATE TABLE "collection_like" (
    "liked" BOOLEAN NOT NULL,
    "createdAt" TIMESTAMP(3) NOT NULL,
    "collectorId" TEXT NOT NULL,
    "collectionId" TEXT NOT NULL,

    PRIMARY KEY ("collectorId","collectionId")
)

CREATE TABLE "media_like" (
    "liked" BOOLEAN NOT NULL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "userId" TEXT NOT NULL,
    "mediaId" TEXT NOT NULL,

    PRIMARY KEY ("userId","mediaId")
)

CREATE TABLE "_GenreToMedia" (
    "A" INTEGER NOT NULL,
    "B" TEXT NOT NULL
)

CREATE UNIQUE INDEX "user.email_unique" ON "user"("email")

CREATE UNIQUE INDEX "profile_userId_unique" ON "profile"("userId")

CREATE UNIQUE INDEX "media.no_unique" ON "media"("no")

CREATE INDEX "media.no_title_index" ON "media"("no", "title")

CREATE UNIQUE INDEX "_GenreToMedia_AB_unique" ON "_GenreToMedia"("A", "B")

CREATE INDEX "_GenreToMedia_B_index" ON "_GenreToMedia"("B")

ALTER TABLE "profile" ADD FOREIGN KEY("userId")REFERENCES "user"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "history" ADD FOREIGN KEY("ownerId")REFERENCES "user"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "history" ADD FOREIGN KEY("mediaId")REFERENCES "media"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "library" ADD FOREIGN KEY("collectorId")REFERENCES "user"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "library" ADD FOREIGN KEY("collectionId")REFERENCES "collection"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "collection_item" ADD FOREIGN KEY("collectionId")REFERENCES "collection"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "collection_item" ADD FOREIGN KEY("mediaId")REFERENCES "media"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "review" ADD FOREIGN KEY("userId")REFERENCES "user"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "review" ADD FOREIGN KEY("mediaId")REFERENCES "media"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "collection_like" ADD FOREIGN KEY("collectorId")REFERENCES "user"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "collection_like" ADD FOREIGN KEY("collectionId")REFERENCES "collection"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "media_like" ADD FOREIGN KEY("userId")REFERENCES "user"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "media_like" ADD FOREIGN KEY("mediaId")REFERENCES "media"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "_GenreToMedia" ADD FOREIGN KEY("A")REFERENCES "genre"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "_GenreToMedia" ADD FOREIGN KEY("B")REFERENCES "media"("id") ON DELETE CASCADE ON UPDATE CASCADE
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20201229151916-add-removed-at-to-history-item..20210129092254-refactor-collection
--- datamodel.dml
+++ datamodel.dml
@@ -1,37 +1,30 @@
 datasource db {
   provider = "postgresql"
-  url = "***"
+  url = "***"
 }
 generator client {
   provider = "prisma-client-js"
 }
 // User
-enum UserRole {
-  USER
-  ADMIN
-}
-
 model User {
   id        String    @id @default(uuid())
   name      String
   email     String    @unique
   password  String
-  verified  Boolean   @default(false)
-  role      UserRole  @default(USER)
   createdAt DateTime  @default(now())
   updatedAt DateTime  @updatedAt
   removedAt DateTime?
-  profile                Profile?
-  histories              History[]
-  collections            Collection[]
-  collectionLikeDisLikes CollectionLikeDisLike[]
-  mediaLikeDisLikes      MediaLikeDisLike[]
-  reviews                Review[]
+  profile         Profile?
+  histories       History[]
+  libraries       Library[]
+  reviews         Review[]
+  collectionLikes CollectionLike[]
+  mediaLikes      MediaLike[]
   @@map(name: "user")
 }
@@ -47,39 +40,19 @@
   JAPANESE
 }
 model Profile {
-  id       Int      @id @default(autoincrement())
   shortBio String?
   avatar   String?
   gender   Gender   @default(SECRET)
   language Language @default(ENGLISH)
   user   User   @relation(fields: [userId], references: [id])
-  userId String
+  userId String @id
   @@map(name: "profile")
 }
-// Review
-
-model Review {
-  id        String   @id @default(uuid())
-  body      String
-  spoiler   Boolean  @default(true)
-  private   Boolean  @default(false)
-  likeCount Int      @default(0)
-  createdAt DateTime @default(now())
-  updatedAt DateTime @updatedAt
-
-  user    User   @relation(fields: [userId], references: [id])
-  userId  String
-  media   Media  @relation(fields: [mediaId], references: [id])
-  mediaId String
-
-  @@map(name: "review")
-}
-
 // History
 enum HistoryCategory {
   PLANNING
@@ -87,72 +60,59 @@
   COMPLETED
 }
 model History {
-  id        String          @id @default(uuid())
-  category  HistoryCategory
-  createdAt DateTime        @default(now())
-  updatedAt DateTime        @updatedAt
-  removedAt DateTime?
+  id          String          @id @default(uuid())
+  category    HistoryCategory
+  repeat      Int             @default(0)
+  private     Boolean         @default(false)
+  completedAt DateTime
+  createdAt   DateTime        @default(now())
+  updatedAt   DateTime        @updatedAt
+  removedAt   DateTime?
-  owner        User          @relation(fields: [ownerId], references: [id])
-  ownerId      String
-  historyItems HistoryItem[]
+  owner   User   @relation(fields: [ownerId], references: [id])
+  ownerId String
+  media   Media  @relation(fields: [mediaId], references: [id])
+  mediaId String
+
   @@map(name: "history")
 }
-model HistoryItem {
-  id          String    @id @default(uuid())
-  repeat      Int       @default(0)
-  private     Boolean   @default(false)
-  completedAt DateTime  @default(now())
-  createdAt   DateTime  @default(now())
-  updatedAt   DateTime  @updatedAt
-  removedAt   DateTime?
+// Collection
-  history   History @relation(fields: [historyId], references: [id])
-  historyId String
-  media     Media   @relation(fields: [mediaId], references: [id])
-  mediaId   String
+model Library {
+  owner   Boolean
+  addedAt DateTime @updatedAt
-  @@map(name: "history_item")
+  collector    User       @relation(fields: [collectorId], references: [id])
+  collectorId  String
+  collection   Collection @relation(fields: [collectionId], references: [id])
+  collectionId String
+
+  @@id([collectorId, collectionId])
+  @@map(name: "library")
 }
-// Collection
-
 model Collection {
   id          String    @id @default(uuid())
-  name        String
+  title       String
   description String?
   private     Boolean   @default(false)
   createdAt   DateTime  @default(now())
   updatedAt   DateTime  @updatedAt
   removedAt   DateTime?
-  collector              User                    @relation(fields: [collectorId], references: [id])
-  collectorId            String
-  collectionLikeDisLikes CollectionLikeDisLike[]
-  collectionItems        CollectionItem[]
+  likes           CollectionLike[]
+  libraries       Library[]
+  collectionItems CollectionItem[]
   @@map(name: "collection")
 }
-model CollectionLikeDisLike {
-  id     Int     @id @default(autoincrement())
-  isLike Boolean
-
-  collector    User       @relation(fields: [collectorId], references: [id])
-  collectorId  String
-  collection   Collection @relation(fields: [collectionId], references: [id])
-  collectionId String
-
-  @@map(name: "collection_like_dislike")
-}
-
 model CollectionItem {
-  createdAt DateTime @default(now())
-  updatedAt DateTime @updatedAt
+  addedAt DateTime @updatedAt
   collection   Collection @relation(fields: [collectionId], references: [id])
   collectionId String
   media        Media      @relation(fields: [mediaId], references: [id])
@@ -163,66 +123,88 @@
 }
 // Media
-enum MediaFormat {
-  TVA
-  OVA
-  ONA
-  MOVIE
-  MUSIC
-  SPECIAL
-}
-
 enum MediaStatus {
+  FINISHED
   RELEASING
-  FINISHED
   UNRELEASED
   CANCELLED
+  HIATUS
 }
 model Media {
-  id           String       @id @default(uuid())
-  no           Int          @unique @default(autoincrement())
-  title        String
-  image        String?
-  synopsis     String?
-  studio       String?
-  format       MediaFormat?
-  status       MediaStatus?
-  startDate    DateTime?
-  endDate      DateTime?
-  episodeCount Int?
-  createdAt    DateTime     @default(now())
-  updatedAt    DateTime     @updatedAt
-  removedAt    DateTime?
+  id          String      @id @default(uuid())
+  no          Int         @unique @default(autoincrement())
+  genres      Genre[]
+  status      MediaStatus
+  title       String
+  synopsis    String?
+  startDate   DateTime?
+  endDate     DateTime?
+  coverImage  String?
+  bannerImage String?
+  createdAt   DateTime    @default(now())
+  updatedAt   DateTime    @updatedAt
+  removedAt   DateTime?
-  mediaLikeDisLikes MediaLikeDisLike[]
-  genres            Genre[]            @relation(references: [id])
-  reviews           Review[]
-  historyItems      HistoryItem[]
-  collectionItems   CollectionItem[]
+  likes           MediaLike[]
+  reviews         Review[]
+  histories       History[]
+  collectionItems CollectionItem[]
-  @@index([no, title, studio])
+  @@index([no, title])
   @@map(name: "media")
 }
-model MediaLikeDisLike {
-  id     Int     @id @default(autoincrement())
-  isLike Boolean
+model Genre {
+  id    Int     @id @default(autoincrement())
+  name  String
+  media Media[]
+  @@map(name: "genre")
+}
+
+// Review
+
+model Review {
+  id        String   @id @default(uuid())
+  content   String
+  private   Boolean  @default(false)
+  createdAt DateTime @default(now())
+  updatedAt DateTime @updatedAt
+
   user    User   @relation(fields: [userId], references: [id])
   userId  String
   media   Media  @relation(fields: [mediaId], references: [id])
   mediaId String
-  @@map(name: "media_like_dislike")
+  @@map(name: "review")
 }
-model Genre {
-  id   Int    @id @default(autoincrement())
-  name String
+// Like
-  media Media[] @relation(references: [id])
+model CollectionLike {
+  liked     Boolean
+  createdAt DateTime
-  @@map(name: "genre")
+  collector    User       @relation(fields: [collectorId], references: [id])
+  collectorId  String
+  collection   Collection @relation(fields: [collectionId], references: [id])
+  collectionId String
+
+  @@id([collectorId, collectionId])
+  @@map(name: "collection_like")
 }
+
+model MediaLike {
+  liked     Boolean
+  createdAt DateTime @default(now())
+
+  user    User   @relation(fields: [userId], references: [id])
+  userId  String
+  media   Media  @relation(fields: [mediaId], references: [id])
+  mediaId String
+
+  @@id([userId, mediaId])
+  @@map(name: "media_like")
+}
```


